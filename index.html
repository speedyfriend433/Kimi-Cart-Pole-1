<!DOCTYPE html>
<html>
<head>
    <title>3-Pole Cartpole Simulation</title>
    <style>
        canvas { border: 1px solid black; }
    </style>
</head>
<body>
    <canvas id="canvas" width="500" height="300"></canvas>
    <script>
        const canvas = document.getElementById("canvas");
        const context = canvas.getContext("2d");
        const WIDTH = canvas.width;
        const HEIGHT = canvas.height;

        // Simulation constants
        const M = 1.0; // Cart mass
        const m = 0.1; // Pole mass
        const L = 1.0; // Pole length
        const g = 9.81; // Gravity
        const dt = 0.02; // Time step
        const scaledL = L * 50; // Scaled length for visualization

        // State variables
        let x = WIDTH / 2; // Cart position (initially centered)
        let v = 0; // Cart velocity
        let theta1 = Math.PI / 20; // Initial angles (slightly tilted)
        let theta2 = Math.PI / 20;
        let theta3 = Math.PI / 20;
        let omega1 = 0; // Angular velocities
        let omega2 = 0;
        let omega3 = 0;

        // Controller gains
        const kp = 5000; // Proportional gain
        const kd = -2000; // Derivative gain (negative for opposing motion)

        function calculateControlForce() {
            // Sum of proportional (angle) and derivative (velocity) terms for each pole
            return kp * (theta1 + theta2 + theta3) + kd * (omega1 + omega2 + omega3);
        }

        function updatePhysics() {
            // Calculate the control force and cart acceleration
            const force = calculateControlForce();
            const acceleration = force / M;

            // Angular acceleration for each pole
            const alpha1 = (3 / (2 * L)) * (acceleration * Math.cos(theta1) - g * Math.sin(theta1));
            const alpha2 = (3 / (2 * L)) * (acceleration * Math.cos(theta2) - g * Math.sin(theta2));
            const alpha3 = (3 / (2 * L)) * (acceleration * Math.cos(theta3) - g * Math.sin(theta3));

            // Update angular velocities and angles
            omega1 += alpha1 * dt;
            omega1 = Math.min(21.0, Math.max(-21.0, omega1)); // Velocity clamping
            theta1 += omega1 * dt;

            omega2 += alpha2 * dt;
            omega2 = Math.min(21.0, Math.max(-21.0, omega2));
            theta2 += omega2 * dt;

            omega3 += alpha3 * dt;
            omega3 = Math.min(21.0, Math.max(-21.0, omega3));
            theta3 += omega3 * dt;

            // Clip angles to prevent large swings
            theta1 = Math.min(Math.PI / 4, Math.max(-Math.PI / 4, theta1));
            theta2 = Math.min(Math.PI / 4, Math.max(-Math.PI / 4, theta2));
            theta3 = Math.min(Math.PI / 4, Math.max(-Math.PI / 4, theta3));

            // Update cart velocity and position
            v += acceleration * dt;
            v = Math.min(8.0, Math.max(-8.0, v)); // Clamp velocity
            x += v * dt;
            if (x < 0) x = 0;
            if (x > WIDTH) x = WIDTH;
        }

        function drawCart() {
            const cartX = x - 25;
            const cartY = HEIGHT - 60;
            context.fillStyle = "blue";
            context.fillRect(cartX, cartY, 50, 60);
        }

        function drawPole(baseX, baseY, theta, length, color) {
            const endX = baseX + Math.sin(theta) * length;
            const endY = baseY - Math.cos(theta) * length;
            context.beginPath();
            context.lineWidth = 2;
            context.strokeStyle = color;
            context.moveTo(baseX, baseY);
            context.lineTo(endX, endY);
            context.stroke();
        }

        function draw() {
            updatePhysics();
            
            context.clearRect(0, 0, WIDTH, HEIGHT);
            drawCart();

            const poleBaseY = HEIGHT - 60;

            // Draw each pole with different colors
            drawPole(x, poleBaseY, theta1, scaledL, 'red');
            drawPole(x, poleBaseY, theta2, scaledL, 'green');
            drawPole(x, poleBaseY, theta3, scaledL, 'yellow');
        }

        // Animation loop
        function animate() {
            draw();
            requestAnimationFrame(animate);
        }

        animate();
    </script>
</body>
</html>
